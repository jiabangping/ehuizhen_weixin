function checkMobile(phoneNum) {
	if(!(/^1[3|4|5|7|8]\d{9}$/.test(phoneNum))){ 
        return false; 
    } 
	return true;
}
var countdown=60;
var timeOut;
function settime() {
	if (countdown == 0) {
        $("#getVerifyCode").attr("disabled",false);
      	$("#getVerifyCode").text("免费获取验证码");
      	countdown = 60;
      	return;
    } else {
    	$("#getVerifyCode").attr("disabled", true);
    	$("#getVerifyCode").text("重新发送(" + countdown + ")");
        countdown--;
    }
		timeOut = setTimeout(function() {
			settime();
    },1000)
}

//验证手机号是否已存在
function verifyPhoneNumExist() {
	var phoneNum = $("#PhoneNum").val().trim();
	var verifyPhoneNumExistUrl = "doctor/existPhoneNum/"+phoneNum;
//alert("verifyPhoneNumExistUrl="+verifyPhoneNumExistUrl);
	 $.ajax({
		url : verifyPhoneNumExistUrl,
		type : 'get',
		cache : false,
		dataType : 'json',
		success : function(data) {
			if(data.result == 'exist') {
				//$("#alertContent").text("该手机号码已存在");
				//showMaskAlert();
				$("#singleBtnModalContent").text("该手机号码已存在");
				$("#singleBtn").text("确定");
				$('#singleBtnModal').modal({backdrop: 'static', keyboard: false});
				$("#singleBtnModal").modal("show");
				
				 $("#getVerifyCode").attr("disabled",false);
				 countdown=60;
				 clearTimeout(timeOut); 
				return;
			}else if("formatErr" == data.result) {
				/*$("#alertContent").text("请输入正确手机号码");
				showMaskAlert();*/
				showUploadResult('请输入正确手机号码');
				 $("#getVerifyCode").attr("disabled",false);
				countdown=60;
				clearTimeout(timeOut); 
				return;
			}else {
				getVerifyCode();
			}
		},
		error : function(data) {
			$("#warn").text("验证手机号失败，请稍后再试。");
		}
	});  
}

//获取验证码
function getVerifyCode() {
	settime();
	//alert("已下发验证码,注意查收");
	var getVerifyCodeUrl = "doctor/getVerifyCode/"+$("#PhoneNum").val().trim();
	$.ajax({
			url : getVerifyCodeUrl,
			type : 'get',
			cache : false,
			dataType : 'json',
			success : function(data) {
				if(data.result == 'success') {
				//	settime(); 
				//	alert("成功下发验证码,verifyCode="+data.verifyCode);
					$("#warn").text("尊敬的用户验证码已下发到您的手机,请注意查收");//verifyCode="+data.verifyCode
					return;
				}else if("formatErr" == data.result) {
					$("#warn").text("请输入正确手机号");
					 $("#getVerifyCode").attr("disabled",false);
					countdown=60;
					clearTimeout(timeOut); 
					return;
				}else if("getVerifyCodeLimit" == data.result){//该手机号码今天接收验证码数目已达上限
					$("#singleBtnModalContent").text("该手机号码今天接收验证码数目已达上限");//这里用得是signUpPage内的signSuccessModal模态框不是公共的
					$('#singleBtnModal').modal({backdrop: 'static', keyboard: false});
					$("#singleBtnModal").modal("show");
				}
			},
			error : function(data) {
				$("#warn").text("验证用户名失败，请稍后再试。");
			}
		});  
}


function hideMaskAlert() {
	$("#maskAlert").hide();
}
function showMaskAlert() {
	$("#maskAlert").fadeIn("slow");
		$("#maskAlert").show();
		setTimeout(hideMaskAlert, 2000);
}
//第一次提交
function firstSubmit() {
	var o = $('input:radio[name=Oversea]:checked').val();
	var s = $('input:radio[name=Sex]:checked').val();
	
	var chargingStandardValue = $("#chargingStandard2").val();
	var chargingStandard = '';
	if(chargingStandardValue != undefined) {
		chargingStandard = $("#chargingStandard2").val().trim();
	}
	var firstSubUrl = "doctor/signUpFirstSubData";
	 $.ajax({
		url : firstSubUrl,
		type : 'post',
		cache : false,
		dataType : 'json',
    	 data : {
	      'oversea' : $('input:radio[name=Oversea]:checked').val(),
	      'sex' : $('input:radio[name=Sex]:checked').val(),
	      'doctorName' : $("#DoctorName").val(),
	      'phoneNum':$("#PhoneNum").val(),
	      'verifyCode':$("#verifyCode").val(),
	      'idCard':$("#IDCard").val(),
	      'chargingStandard':chargingStandard
	     },
		success : function(data) {
			$("#dataLoad").hide();
			if(data.result == 'success') {
				$("#first").hide();
				$("#userName").text($("#DoctorName").val());
				$("#second").show();
				firstSubmitSuccessSetCookie();
			}else if(data.result == 'verifyError') {
				/*$("#alertContent").text('验证码错误');
				showMaskAlert();*/
				showUploadResult('验证码错误');
			}else if(data.result == 'exist') {
				/*$("#alertContent").text('手机号已存在');
				showMaskAlert();*/
				showUploadResult('手机号已存在');
			}else if(data.result == 'fail') {
				/*$("#alertContent").text('失败,请重试');
				showMaskAlert();*/
				showUploadResult('失败,请重试');
			}else if(data.result == 'lackRequiredField') {
				/*$("#alertContent").text('缺少必填字段,请重试');
				showMaskAlert();*/
				showUploadResult('缺少必填字段,请重试');
 			}else {
			}
		},
		error : function(data) {
		}
	});  
}
//2次提交
function secondSubmit() {
	$("#dataSubmit").show();
	var secondSubUrl = "doctor/signUpSecondSubData";
	 $.ajax({
		url : secondSubUrl,
		type : 'post',
		cache : false,
		dataType : 'json',
    	 data : {
	      'phoneNum':$("#PhoneNum").val(),
	      'verifyCode':$("#verifyCode").val(),
	      'hospital':$("#hospital").val(),
	      'department':$("#department").val(),
	      'position':$("#position").val(),
	      'skilledField':$("#skilledField").val(),
	      'selfIntro':$("#selfIntro").val(),
	      'doctorCertNo':$("#doctorCertNo").val(),
	      //'chargingStandard':$("#chargingStandard").val(),
	      'email':$("#email").val(),
	      'selfPhotoUrl':$("#selfPhotoUrlHidden").val()
	     },
		success : function(data) {
			$("#dataSubmit").hide();
			if(data.result == 'success') {
				//$("#alertContent").css({"font-size":"13px"})
			//	$("#alertContent").text('提交成功,待审核中');
			//	showMaskAlert();
//$("#phoneNumHidden").val(data.phoneNum);
//window.location.href="doctor/waitAudit?phoneNum="+$("#phoneNumHidden").val();
				$("#signSuccessModalContent").text("注册成功,等待审核");//这里用得是signUpPage内的signSuccessModal模态框不是公共的
				$('#signSuccessModal').modal({backdrop: 'static', keyboard: false});
				$("#signSuccessModal").modal("show");
				
				var expiresHours = 7*24;
				var registerStatus = "OK";
				addCookie("registerStatus",registerStatus,expiresHours);
				
				
			}else if(data.result == 'fail') {
				//$("#alertContent").text('失败,请重试');
				//showMaskAlert();
				$("#2btnModalContent").text("失败");
				$('#2btnModal').modal({backdrop: 'static', keyboard: false});
				$("#2btnModal").modal("show");
			}else {
			}
		},
		error : function(data) {
		}
	});  
}

function getFileName(o){
    var pos=o.lastIndexOf("\\");
    return o.substring(pos+1);  
}

//定时器对象
var uploadProcessTimer = null;

//获取文件上传进度
function getFileUploadProcess() {
	$.get('upload/getFileProcessServlet', function(data) {
		$('#fileUploadProcess').html(data);
	});
}

function hideUploadResultModal() {
	$("#singleBtnModal").modal('hide');
}

function showUploadResult(msg) {
	$("#singleBtnModalContent").text(msg);
	$("#singleBtn").text("确定");
	$('#singleBtnModal').modal({backdrop: 'static', keyboard: false});
	$("#singleBtnModal").modal("show");
	setTimeout(hideUploadResultModal,1500);
}

function ajaxFileUpload() {
	var file = $("#fileToUpload").val();
	var fileName = getFileName(file);
	if(fileName == ''|| fileName.length<=0) {
		/*$("#alertContent").text('请选择文件');
		showMaskAlert();*/
		/*$("#singleBtnModalContent").text("请选择文件");
		$("#singleBtn").text("确定");
		$('#singleBtnModal').modal({backdrop: 'static', keyboard: false});
		$("#singleBtnModal").modal("show");*/
		showUploadResult("请选择文件");
		return;
	}
	$("#dataUpload").show();
	
	//设置加载图标的显示
	//$('#loading').show();
//	uploadProcessTimer = window.setInterval(getFileUploadProcess, 20);

	$.ajaxFileUpload ({
		url:'upload/ajaxUploadServlet',
		secureuri:false,
		fileElementId:'fileToUpload',
		dataType: 'json',
		//data:{name: $('#name').val()},
		data:{name: $('#PhoneNum').val()},
		success: function (data, status) {
			$("#dataUpload").hide();
			console.log(data);
			console.log(status);
			//$("#clickForUploadAlert").remove();
			$("#uploadBtn").removeClass('error');
			$("#selfPhotoAlert").css({"display":"none"})

			/*$("#alertContent").text(data['message']);
			showMaskAlert();*/
			showUploadResult(data['message']);
			//上传成功
			
			$("#selfPhotoUrlHidden").val(data.url);
			$("#photo").attr("src",data.url);
			$("#photo").show();
			//清除定时器
			/* if(uploadProcessTimer) {
				window.clearInterval(uploadProcessTimer);
			} */
			//$('#loading').hide();
	//		$("#test").attr("src",data.url);
			/* var message = data['message'];
			var code = data['code'];
			if(code != 200) {
				$('#fileUploadProcess').html('0%');
			}
			if(message){
				alert(data.message);
			} */
		},
		error: function (data, status, e){
			//清除定时器
			/* if(uploadProcessTimer) {
				window.clearInterval(uploadProcessTimer);
			} */
			//$('#loading').hide();
			//这里处理的是网络异常，返回参数解析异常，DOM操作异常
			//alert("上传发生异常");
			/*$("#alertContent").text('失败，请重试');
			showMaskAlert();*/
			//上传失败,请重试
			showUploadResult('失败，请重试');
		}
	})
}

function check() {
    if ($("#InfoInput").valid()) {
        return true;
    }
    else {
        return false;
    }
}

function firstCheckForNextStep() {
    if ($("#InfoInput1").valid()) {
        return true;
    } else {
        return false;
    }
}

function secondCheckForSubmit() {
	checkPhoto();
    if ($("#InfoInput2").valid()) {
        return true;
    } else {
        return false;
    }
}

function changeUploadBtnDanger() {
	$("#uploadBtn").removeClass('btn-danger');
}
function changeUploadBtn() {
	$("#uploadBtn").addClass('btn-danger');
	setTimeout(changeUploadBtnDanger,200);
}

function checkPhoto() {
	if($("#selfPhotoUrlHidden").val() == ''||$("#selfPhotoUrlHidden").val().length<=0) {
		var c = "<label id='selfPhotoAlert' for='fileToUpload' >请选择图片</label>";
		if($("#fileName").val().trim() == '' && document.getElementById("selfPhotoAlert") == null) {
			/*$("#fileBox").addClass('error');*/
			$("#fileName").addClass('error');
			$("#fileToUploadGroup").append(c);
			$("#selfPhotoAlert").css({
				"display":"block","color":"red",   
				"position": "absolute",
				"top": "33px"
			})
		}else if($("#fileName").val().trim() != ''){
			//if(document.getElementById("clickForUploadAlert") == null) {
				//var clickAlert = "<label id='clickForUploadAlert' for='' style='color:red;margin-left:5px;display:none' >点击上传</label>";
				$("#uploadBtn").addClass('error');
				//$("#uploadBtnGroup").append(clickAlert);
				
				changeUploadBtn();
			//}
		}
		return false;
	}else {
		$("#selfPhotoAlert").remove();
		return true;
	}
}


function initGetFirstSuccessCookie() {
	var Oversea = getCookie("Oversea");
	if(Oversea != "") {
		$("input[name=Oversea][value="+Oversea+"]").attr("checked",true);
		if(Oversea == "1") {//是海外
			 if(document.getElementById("chargingStandard") == null) {
				 var chargingStandardValue = getCookie("chargingStandard2");
				 if(chargingStandardValue == undefined || chargingStandardValue == null) {
					 chargingStandardValue = '';
				 }
				 var chargingStandard =
			 	"<div class='form-group' id='chargingStandard'>"+
		            "<label class='control-label' for='inputError1'>收费标准</label>"+
		            	"<input name='chargingStandard2' id='chargingStandard2' class='form-control {required:true} ' type='text' value='"+chargingStandardValue+"'>"+
		            "</div>"+
		        "</div>";
				
				
		    	$("#chargingStandardGroup").append(chargingStandard);	
			 }
		}else if(Oversea == "0" ) {//国内
			if(document.getElementById("chargingStandard") != null) {
				$("#chargingStandard").remove();
			}
		}
	}
	
	var Sex = getCookie("Sex");
	if(Oversea != "") {
		$("input[name=Sex][value="+Sex+"]").attr("checked",true);
	}
	
	var DoctorName = unescape(getCookie("DoctorName"));
	if(DoctorName != "") {
		$("#DoctorName").val(DoctorName);
		$("#userName").text(DoctorName);
	}
	var PhoneNum = getCookie("PhoneNum");
	if(PhoneNum != "") {
		$("#PhoneNum").val(PhoneNum);
	}
	
	var verifyCode = getCookie("verifyCode");
	if(verifyCode !="" ) {
		$("#verifyCode").val(verifyCode);
	}
	
	var IDCard = getCookie("IDCard");
	if(IDCard != "") {
		$("#IDCard").val(IDCard);
	}
}


function initGetCookie() {
	
	var registerStatus = getCookie("registerStatus");
	if(registerStatus != "" && registerStatus == "OK") {
		//window.location.href="doctor/waitAudit";
		//在这里隐藏 注册页面
		$("#Div1").css({"display":"none"});
			$("#alreadyRegisteModalContent").text("您已经完成注册,账号等待审核中");
			$("#alreadyRegisteModalBtn").text("确定");
			$('#alreadyRegisteModal').modal({backdrop: 'static', keyboard: false});
			$("#alreadyRegisteModal").modal("show");
		return;
	}
	
	var firstSubmitStatus = getCookie("firstSubmitStatus");
	if(firstSubmitStatus != "" && firstSubmitStatus == "Success") {
		$("#first").hide();
		$("#second").show();
	}
	
	initGetFirstSuccessCookie();
}

function firstSubmitSuccessSetCookie() {
	var expiresHours = 7*24;
	addCookie("firstSubmitStatus","Success",expiresHours);
}

function initSetCookie() {
	var expiresHours = 7*24;
	try {
	var Oversea = $("input:radio[name='Oversea']:checked").val();
	}catch(e){
		console.log(e);
	}
	addCookie("Oversea",Oversea,expiresHours);
	var Sex = $('input:radio[name=Sex]:checked').val();
	addCookie("Sex",Sex,expiresHours);
	
	addCookie("DoctorName",$("#DoctorName").val(),expiresHours);
	addCookie("PhoneNum",$("#PhoneNum").val(),expiresHours);
	addCookie("verifyCode",$("#verifyCode").val(),expiresHours);
	var idCard = $("#IDCard").val();
	addCookie("IDCard",idCard,expiresHours);
	addCookie("chargingStandard2",$("#chargingStandard2").val(),expiresHours);
}

$(function() {	
		
	if($("#first-status").val() == 'onlyFinishFirstStep') {
		var firstSubmitStatus = getCookie("firstSubmitStatus");
		if(firstSubmitStatus != "" && firstSubmitStatus == "Success") {
			initGetFirstSuccessCookie();
		}
		$('#onlyFinishFirstStepModal').modal({backdrop: 'static', keyboard: false});
		$("#onlyFinishFirstStepModal").modal("show");
	}
	$("#onlyFinishFirstStepModal-leftBtn").text("重新注册").click(function() {
		$("input[name=Oversea][value=0]").attr("checked",true);
		$("input[name=Sex][value=1]").attr("checked",true);
		$("#DoctorName").val('');
		$("#PhoneNum").val('');
		$("#verifyCode").val('');
		$("#IDCard").val('');
		
		$("#onlyFinishFirstStepModal").modal("hide");
	})
	
	$("#onlyFinishFirstStepModal-rightBtn").text("完善资料").click(function() {
		$("#onlyFinishFirstStepModal").modal("hide");
		initGetCookie();
	})
		
		
	//initGetCookie();
	$("#alreadyRegisteModalBtn").click(function() {//查询账号审核状态
		$("#alreadyRegisteModal").modal("hide");
		WeixinJSBridge.call('closeWindow');
		/*
		$("#queryAccountModalBtn").text("关闭");
		$('#queryAccountModal').modal({backdrop: 'static', keyboard: false});
		$("#queryAccountModal").modal("show");*/
	})
	
	
	$("#singleBtn").text("确定").click(function() {
		// WeixinJSBridge.call('closeWindow');
		
		$("#singleBtnModal").modal('hide');
	})
	$("#2btnModal-leftBtn").text("绑定").click(function() {
		$("#2btnModal").hide();
	    window.location.href="doctor/signInPage";
	})
	$("#2btnModal-rightBtn").text("重试").click(function() {
		$("#2btnModal").hide();
		window.location.href="doctor/signUpPage?protocolConfirm=1&timestamp="+new Date().getTime();
	})
	
	$("#signSuccessBtn").text("确定").click(function() {
		$("#signSuccessModal").modal("hide");
		WeixinJSBridge.call('closeWindow');
	})
    	
	
	 var tel = /^([0-9]|[0-1][0-9]|[2][0-3]):([0-5][0-9])$/;
	 var error =  "<label class='error' id='phoneError' generated='true' for='PhoneNum'>无效的手机号码</label>";
	$("#getVerifyCode").click(function() {
		var phoneNum = $("#PhoneNum").val();
		if(!checkMobile(phoneNum)) {
			if(document.getElementById("phoneError") == null) {
				$("#phoneNumGroup").append(error);
				return;
			}
		}else {  
			$("#phoneError").remove();
			if($("#getVerifyCode").attr("disabled") != 'disabled') {
				$("#getVerifyCode").attr("disabled", true);
				verifyPhoneNumExist();
			}
		}
	});
	
	$('#addrRadioGroup input').on('ifChecked', function(event){
		//console.log(event.target.value)
		if(event.target.value == 1) {
	        var chargingStandard ="<div class='form-group' id='chargingStandard'>"+
	                "<label class='control-label' for='inputError1'>收费标准</label>"+
	                "<input name='chargingStandard2' id='chargingStandard2' class='form-control {required:true} ' type='text'>"+
	            "</div>"+
            "</div>";
	        if(document.getElementById("chargingStandard") == null) {
	        	$("#chargingStandardGroup").append(chargingStandard);	
			}
		}else {
			if(document.getElementById("chargingStandard") != null) {
				$("#chargingStandard").remove();
			}
		}
	}).iCheck({
		  checkboxClass: 'icheckbox_square-blue',
		  radioClass: 'iradio_square-blue',
		  increaseArea: '20%'
	});
	
	$('#sexRadioGroup input').on('ifChecked', function(event){
		//console.log(event.target.value)
		
	}).iCheck({
		  checkboxClass: 'icheckbox_square-blue',
		  radioClass: 'iradio_square-blue',
		  increaseArea: '20%'
	});
	
	/*
	$('input:radio[name=Oversea]').each(function(i) {
		$(this).click(function() {
			var checkVal = $('input:radio[name=Oversea]:checked').val();
			if(checkVal == 1) {
		        var chargingStandard ="<div class='form-group' id='chargingStandard'>"+
		                "<label class='control-label' for='inputError1'>收费标准</label>"+
		                "<input name='chargingStandard2' id='chargingStandard2' class='form-control {required:true} ' type='text'>"+
		            "</div>"+
	            "</div>";
		        if(document.getElementById("chargingStandard") == null) {
		        	$("#chargingStandardGroup").append(chargingStandard);	
				}
			}else {
				if(document.getElementById("chargingStandard") != null) {
					$("#chargingStandard").remove();
				}
			}
		})
	})*/
	
	
	$("#nextStep").click(function() {
		var result = firstCheckForNextStep();
		if(result) {
			$("#dataLoad").show();
			
			initSetCookie();
			firstSubmit();
		}
	})
	
	$("#secondSubmit").click(function() {
		var result1 = secondCheckForSubmit();
		var result2= checkPhoto();
		if(result1 && result2) {
			secondSubmit();
		}
	})
	
	$("#uploadBtn").click(function() {
		ajaxFileUpload();
	});
	$("#fileToUpload").change(function() {
		/*$("#fileBox").removeClass('error');*/
		$("#fileName").removeClass('error');
		var file = $("#fileToUpload").val();
		var fileName = getFileName(file);
		if(fileName != null && fileName != '') {
			if(document.getElementById("selfPhotoAlert") != null) {
				$("#selfPhotoAlert").remove();
			}
		}
		$("#fileName").val(fileName);
	})
})